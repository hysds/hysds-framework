version: 2.1
commands:
  install_deps:
    steps:
      - run:
          name: Install dependencies
          command: |
            apk add --no-cache \
              python3-dev py3-pip bash pigz build-base libffi-dev openssl-dev gcc musl-dev cargo

  setup_buildx:
    steps:
      - run:
          name: Setup Docker Buildx for multi-platform builds
          command: |
            # Enable experimental features
            mkdir -p ~/.docker
            echo '{"experimental": "enabled"}' > ~/.docker/config.json
            
            # Create and use a new builder instance
            docker buildx create --name multiarch --driver docker-container --use
            docker buildx inspect --bootstrap

  prep_env:
    steps:
      - run:
          name: Prepare environment
          command: |
            mkdir -p images
            echo "$DOCKER_PASS" | docker login -u $DOCKER_USER --password-stdin
            echo "GIT_OAUTH_TOKEN=${GIT_OAUTH_TOKEN}" > $HOME/.git_oauth_token
jobs:
  test:
    docker:
      - image: hysds/pge-base:latest
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    steps:
      - checkout
      - run:
          name: Test
          command: |
            source $HOME/verdi/bin/activate
            pip install pytest
            echo 'export PYTHONPATH="$CIRCLE_WORKING_DIRECTORY:$PYTHONPATH"' >> $BASH_ENV
            source $BASH_ENV
            pytest
  build-redis:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    #resource_class: large
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: master
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/redis
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull multi-platform base image
            docker pull --platform linux/amd64 hysds/base:<< parameters.final_tag >>
            docker pull --platform linux/arm64 hysds/base:<< parameters.final_tag >>
            
            git clone --single-branch -b << parameters.branch >> https://github.com/<< parameters.org >>/puppet-redis.git redis
            cd redis
            
            # Set environment variable to enable multi-platform builds in build script
            export DOCKER_BUILDX_PLATFORM="linux/amd64,linux/arm64"
            export USE_BUILDX=1
            
            ./build_docker.sh $build_tag << parameters.org >> << parameters.branch >> << parameters.final_tag >>
            cd ..
            rm -rf redis
            
            # Tag and push using buildx imagetools if build script doesn't handle it
            if [ "$push_build_tag" -eq 1 ]; then
              docker buildx imagetools create -t hysds/redis:<< parameters.final_tag >> hysds/redis:${build_tag}
            fi
  build-elasticsearch:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    #resource_class: large
    parameters:
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/elasticsearch
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull multi-platform elasticsearch image
            docker pull --platform linux/amd64 docker.io/elasticsearch:7.9.3
            docker pull --platform linux/arm64 docker.io/elasticsearch:7.9.3
            
            # Create manifest list for multi-platform support
            if [ "$push_build_tag" -eq 1 ]; then
              docker buildx imagetools create -t hysds/elasticsearch:${build_tag} docker.io/elasticsearch:7.9.3
              docker buildx imagetools create -t hysds/elasticsearch:<< parameters.final_tag >> docker.io/elasticsearch:7.9.3
            else
              docker buildx imagetools create -t hysds/elasticsearch:<< parameters.final_tag >> docker.io/elasticsearch:7.9.3
            fi
  build-rabbitmq:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    #resource_class: large
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/rabbitmq
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            docker pull --platform linux/amd64 docker.io/rabbitmq:3-management
            docker pull --platform linux/arm64 docker.io/rabbitmq:3-management
            git clone --single-branch -b << parameters.branch >> https://github.com/<< parameters.org >>/rabbitmq.git
            cd rabbitmq
            # Build and push multi-platform image
            if [ "$push_build_tag" -eq 1 ]; then
              docker buildx build --platform linux/amd64,linux/arm64 \
                -t hysds/rabbitmq:${build_tag} -t hysds/rabbitmq:<< parameters.final_tag >> \
                -f docker/Dockerfile . --push
            else
              docker buildx build --platform linux/amd64,linux/arm64 \
                -t hysds/rabbitmq:<< parameters.final_tag >> \
                -f docker/Dockerfile . --push
            fi
  build-hysds_base-amd64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/base (amd64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            git clone --single-branch -b << parameters.branch >> https://github.com/<< parameters.org >>/puppet-hysds_base.git hysds_base
            cd hysds_base
            # Build and push amd64 image (without buildx to create single-platform images)
            if [ "$push_build_tag" -eq 1 ]; then
              docker build --progress=plain --rm --force-rm \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/base:${build_tag}-amd64 -t hysds/base:<< parameters.final_tag >>-amd64 \
                -f docker/Dockerfile .
              docker push hysds/base:${build_tag}-amd64
              docker push hysds/base:<< parameters.final_tag >>-amd64
            else
              docker build --progress=plain --rm --force-rm \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/base:<< parameters.final_tag >>-amd64 \
                -f docker/Dockerfile .
              docker push hysds/base:<< parameters.final_tag >>-amd64
            fi
  build-hysds_base-arm64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    resource_class: arm.medium
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/base (arm64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            git clone --single-branch -b << parameters.branch >> https://github.com/<< parameters.org >>/puppet-hysds_base.git hysds_base
            cd hysds_base
            # Build and push arm64 image (without buildx to create single-platform images)
            if [ "$push_build_tag" -eq 1 ]; then
              docker build --progress=plain --rm --force-rm \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/base:${build_tag}-arm64 -t hysds/base:<< parameters.final_tag >>-arm64 \
                -f docker/Dockerfile .
              docker push hysds/base:${build_tag}-arm64
              docker push hysds/base:<< parameters.final_tag >>-arm64
            else
              docker build --progress=plain --rm --force-rm \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/base:<< parameters.final_tag >>-arm64 \
                -f docker/Dockerfile .
              docker push hysds/base:<< parameters.final_tag >>-arm64
            fi
  build-hysds_base-manifest:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - setup_remote_docker:
          version: default
      - prep_env
      - run:
          name: Create multi-platform manifest for hysds/base
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Create and push manifest
            if [ "$push_build_tag" -eq 1 ]; then
              docker manifest create hysds/base:${build_tag} \
                hysds/base:${build_tag}-amd64 \
                hysds/base:${build_tag}-arm64
              docker manifest push hysds/base:${build_tag}
              
              docker manifest create hysds/base:<< parameters.final_tag >> \
                hysds/base:<< parameters.final_tag >>-amd64 \
                hysds/base:<< parameters.final_tag >>-arm64
              docker manifest push hysds/base:<< parameters.final_tag >>
            else
              docker manifest create hysds/base:<< parameters.final_tag >> \
                hysds/base:<< parameters.final_tag >>-amd64 \
                hysds/base:<< parameters.final_tag >>-arm64
              docker manifest push hysds/base:<< parameters.final_tag >>
            fi
  build-hysds_cuda_base-amd64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/cuda-base (amd64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull amd64 base image
            docker pull hysds/base:<< parameters.final_tag >>-amd64
            
            git clone --single-branch -b << parameters.branch >> https://github.com/<< parameters.org >>/puppet-hysds_base.git hysds_base
            cd hysds_base
            
            # Build and push amd64 image (without buildx to create single-platform images)
            if [ "$push_build_tag" -eq 1 ]; then
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >> \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/cuda-base:${build_tag}-amd64 -t hysds/cuda-base:<< parameters.final_tag >>-amd64 \
                -f docker/Dockerfile.cuda .
              docker push hysds/cuda-base:${build_tag}-amd64
              docker push hysds/cuda-base:<< parameters.final_tag >>-amd64
            else
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >> \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/cuda-base:<< parameters.final_tag >>-amd64 \
                -f docker/Dockerfile.cuda .
              docker push hysds/cuda-base:<< parameters.final_tag >>-amd64
            fi
  build-hysds_cuda_base-arm64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    resource_class: arm.medium
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/cuda-base (arm64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull arm64 base image
            docker pull hysds/base:<< parameters.final_tag >>-arm64
            
            git clone --single-branch -b << parameters.branch >> https://github.com/<< parameters.org >>/puppet-hysds_base.git hysds_base
            cd hysds_base
            
            # Build and push arm64 image (without buildx to create single-platform images)
            if [ "$push_build_tag" -eq 1 ]; then
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >> \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/cuda-base:${build_tag}-arm64 -t hysds/cuda-base:<< parameters.final_tag >>-arm64 \
                -f docker/Dockerfile.cuda .
              docker push hysds/cuda-base:${build_tag}-arm64
              docker push hysds/cuda-base:<< parameters.final_tag >>-arm64
            else
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >> \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/cuda-base:<< parameters.final_tag >>-arm64 \
                -f docker/Dockerfile.cuda .
              docker push hysds/cuda-base:<< parameters.final_tag >>-arm64
            fi
  build-hysds_cuda_base-manifest:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - setup_remote_docker:
          version: default
      - prep_env
      - run:
          name: Create multi-platform manifest for hysds/cuda-base
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Create and push manifest
            if [ "$push_build_tag" -eq 1 ]; then
              docker manifest create hysds/cuda-base:${build_tag} \
                hysds/cuda-base:${build_tag}-amd64 \
                hysds/cuda-base:${build_tag}-arm64
              docker manifest push hysds/cuda-base:${build_tag}
              
              docker manifest create hysds/cuda-base:<< parameters.final_tag >> \
                hysds/cuda-base:<< parameters.final_tag >>-amd64 \
                hysds/cuda-base:<< parameters.final_tag >>-arm64
              docker manifest push hysds/cuda-base:<< parameters.final_tag >>
            else
              docker manifest create hysds/cuda-base:<< parameters.final_tag >> \
                hysds/cuda-base:<< parameters.final_tag >>-amd64 \
                hysds/cuda-base:<< parameters.final_tag >>-arm64
              docker manifest push hysds/cuda-base:<< parameters.final_tag >>
            fi
  build-hysds_dev-amd64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/dev (amd64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull amd64 base image
            docker pull hysds/base:<< parameters.final_tag >>-amd64
            
            git clone --single-branch -b << parameters.branch >> https://github.com/<< parameters.org >>/puppet-hysds_dev.git hysds_dev
            cd hysds_dev
            
            # Build and push amd64 image (without buildx to create single-platform images)
            if [ "$push_build_tag" -eq 1 ]; then
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >> \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/dev:${build_tag}-amd64 -t hysds/dev:<< parameters.final_tag >>-amd64 \
                -f docker/Dockerfile .
              docker push hysds/dev:${build_tag}-amd64
              docker push hysds/dev:<< parameters.final_tag >>-amd64
            else
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >> \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/dev:<< parameters.final_tag >>-amd64 \
                -f docker/Dockerfile .
              docker push hysds/dev:<< parameters.final_tag >>-amd64
            fi
  build-hysds_dev-arm64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    resource_class: arm.medium
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/dev (arm64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull arm64 base image
            docker pull hysds/base:<< parameters.final_tag >>-arm64
            
            git clone --single-branch -b << parameters.branch >> https://github.com/<< parameters.org >>/puppet-hysds_dev.git hysds_dev
            cd hysds_dev
            
            # Build and push arm64 image (without buildx to create single-platform images)
            if [ "$push_build_tag" -eq 1 ]; then
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >> \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/dev:${build_tag}-arm64 -t hysds/dev:<< parameters.final_tag >>-arm64 \
                -f docker/Dockerfile .
              docker push hysds/dev:${build_tag}-arm64
              docker push hysds/dev:<< parameters.final_tag >>-arm64
            else
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >> \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/dev:<< parameters.final_tag >>-arm64 \
                -f docker/Dockerfile .
              docker push hysds/dev:<< parameters.final_tag >>-arm64
            fi
  build-hysds_dev-manifest:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - setup_remote_docker:
          version: default
      - prep_env
      - run:
          name: Create multi-platform manifest for hysds/dev
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Create and push manifest
            if [ "$push_build_tag" -eq 1 ]; then
              docker manifest create hysds/dev:${build_tag} \
                hysds/dev:${build_tag}-amd64 \
                hysds/dev:${build_tag}-arm64
              docker manifest push hysds/dev:${build_tag}
              
              docker manifest create hysds/dev:<< parameters.final_tag >> \
                hysds/dev:<< parameters.final_tag >>-amd64 \
                hysds/dev:<< parameters.final_tag >>-arm64
              docker manifest push hysds/dev:<< parameters.final_tag >>
            else
              docker manifest create hysds/dev:<< parameters.final_tag >> \
                hysds/dev:<< parameters.final_tag >>-amd64 \
                hysds/dev:<< parameters.final_tag >>-arm64
              docker manifest push hysds/dev:<< parameters.final_tag >>
            fi
  build-hysds_cuda_dev-amd64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/cuda-dev (amd64)
          command: |
            set -ex
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull amd64 base image
            docker pull hysds/cuda-base:<< parameters.final_tag >>-amd64
            
            git clone --single-branch -b << parameters.branch >> https://github.com/<< parameters.org >>/puppet-hysds_dev.git hysds_dev
            cd hysds_dev
            
            # Build and push amd64 image (without buildx to create single-platform images)
            if [ "$push_build_tag" -eq 1 ]; then
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >>-amd64 \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/cuda-dev:${build_tag} -t hysds/cuda-dev:<< parameters.final_tag >>-amd64 \
                -f docker/Dockerfile.cuda .
              docker push hysds/cuda-dev:${build_tag}
              docker push hysds/cuda-dev:<< parameters.final_tag >>-amd64
            else
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >>-amd64 \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/cuda-dev:<< parameters.final_tag >>-amd64 \
                -f docker/Dockerfile.cuda .
              docker push hysds/cuda-dev:<< parameters.final_tag >>-amd64
            fi
  build-hysds_cuda_dev-arm64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    resource_class: arm.medium
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/cuda-dev (arm64)
          command: |
            set -ex
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull arm64 base image
            docker pull hysds/cuda-base:<< parameters.final_tag >>-arm64
            
            git clone --single-branch -b << parameters.branch >> https://github.com/<< parameters.org >>/puppet-hysds_dev.git hysds_dev
            cd hysds_dev
            
            # Build and push arm64 image (without buildx to create single-platform images)
            if [ "$push_build_tag" -eq 1 ]; then
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >>-arm64 \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/cuda-dev:${build_tag} -t hysds/cuda-dev:<< parameters.final_tag >>-arm64 \
                -f docker/Dockerfile.cuda .
              docker push hysds/cuda-dev:${build_tag}
              docker push hysds/cuda-dev:<< parameters.final_tag >>-arm64
            else
              docker build --progress=plain --rm --force-rm \
                --build-arg TAG=<< parameters.final_tag >>-arm64 \
                --build-arg ORG=<< parameters.org >> --build-arg BRANCH=<< parameters.branch >> \
                -t hysds/cuda-dev:<< parameters.final_tag >>-arm64 \
                -f docker/Dockerfile.cuda .
              docker push hysds/cuda-dev:<< parameters.final_tag >>-arm64
            fi
  build-hysds_cuda_dev-manifest:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      branch:
        type: string
        default: develop
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - prep_env
      - run:
          name: Create hysds/cuda-dev manifest
          command: |
            set -ex
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Create and push manifest for final_tag
            if [ "$push_build_tag" -eq 1 ]; then
              docker manifest create hysds/cuda-dev:${build_tag} \
                hysds/cuda-dev:<< parameters.final_tag >>-amd64 \
                hysds/cuda-dev:<< parameters.final_tag >>-arm64
              docker manifest push hysds/cuda-dev:${build_tag}
            fi
            docker manifest create hysds/cuda-dev:<< parameters.final_tag >> \
              hysds/cuda-dev:<< parameters.final_tag >>-amd64 \
              hysds/cuda-dev:<< parameters.final_tag >>-arm64
            docker manifest push hysds/cuda-dev:<< parameters.final_tag >>
  build-hysds_verdi_pge_base-amd64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/pge-base and hysds/verdi (amd64)
          command: |
            set -ex
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull amd64 base images
            docker pull hysds/base:<< parameters.final_tag >>-amd64
            docker pull hysds/dev:<< parameters.final_tag >>-amd64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-verdi.git
            cd puppet-verdi
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker.sh << parameters.final_tag >>-amd64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-amd64 << parameters.base_branch >>
            
            # Push the images
            docker push hysds/pge-base:<< parameters.final_tag >>-amd64
            docker push hysds/verdi:<< parameters.final_tag >>-amd64
            
            cd ..
            rm -rf puppet-verdi
  build-hysds_verdi_pge_base-arm64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    resource_class: arm.medium
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/pge-base and hysds/verdi (arm64)
          command: |
            set -ex
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull arm64 base images
            docker pull hysds/base:<< parameters.final_tag >>-arm64
            docker pull hysds/dev:<< parameters.final_tag >>-arm64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-verdi.git
            cd puppet-verdi
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker.sh << parameters.final_tag >>-arm64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-arm64 << parameters.base_branch >>
            
            # Push the images
            docker push hysds/pge-base:<< parameters.final_tag >>-arm64
            docker push hysds/verdi:<< parameters.final_tag >>-arm64
            
            cd ..
            rm -rf puppet-verdi
  build-hysds_verdi_pge_base-manifest:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - setup_remote_docker:
          version: default
      - install_deps
      - prep_env
      - run:
          name: Create multi-platform manifests for hysds/pge-base and hysds/verdi
          command: |
            set -ex
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            
            # Create and push manifests for pge-base
            if [ "$push_build_tag" -eq 1 ]; then
              docker manifest create hysds/pge-base:${build_tag} \
                hysds/pge-base:${build_tag}-amd64 \
                hysds/pge-base:${build_tag}-arm64
              docker manifest push hysds/pge-base:${build_tag}
            fi
            docker manifest create hysds/pge-base:<< parameters.final_tag >> \
              hysds/pge-base:<< parameters.final_tag >>-amd64 \
              hysds/pge-base:<< parameters.final_tag >>-arm64
            docker manifest push hysds/pge-base:<< parameters.final_tag >>
            
            # Create and push manifests for verdi
            if [ "$push_build_tag" -eq 1 ]; then
              docker manifest create hysds/verdi:${build_tag} \
                hysds/verdi:${build_tag}-amd64 \
                hysds/verdi:${build_tag}-arm64
              docker manifest push hysds/verdi:${build_tag}
            fi
            docker manifest create hysds/verdi:<< parameters.final_tag >> \
              hysds/verdi:<< parameters.final_tag >>-amd64 \
              hysds/verdi:<< parameters.final_tag >>-arm64
            docker manifest push hysds/verdi:<< parameters.final_tag >>
            
            # Save architecture-specific images for verdi
            mkdir -p images
            cd images
            if [ "$push_build_tag" -eq 1 ]; then
              # Save amd64 image (no suffix for backwards compatibility)
              docker pull --platform linux/amd64 hysds/verdi:${build_tag}-amd64
              docker save hysds/verdi:${build_tag}-amd64 > hysds-verdi-${build_tag}.tar
              pigz -f hysds-verdi-${build_tag}.tar
              
              # Save arm64 image (with suffix)
              docker pull --platform linux/arm64 hysds/verdi:${build_tag}-arm64
              docker save hysds/verdi:${build_tag}-arm64 > hysds-verdi-${build_tag}-arm64.tar
              pigz -f hysds-verdi-${build_tag}-arm64.tar
            fi
            
            # Save amd64 image for final_tag (no suffix for backwards compatibility)
            docker pull --platform linux/amd64 hysds/verdi:<< parameters.final_tag >>-amd64
            docker save hysds/verdi:<< parameters.final_tag >>-amd64 > hysds-verdi-<< parameters.final_tag >>.tar
            pigz -f hysds-verdi-<< parameters.final_tag >>.tar
            
            # Save arm64 image for final_tag (with suffix)
            docker pull --platform linux/arm64 hysds/verdi:<< parameters.final_tag >>-arm64
            docker save hysds/verdi:<< parameters.final_tag >>-arm64 > hysds-verdi-<< parameters.final_tag >>-arm64.tar
            pigz -f hysds-verdi-<< parameters.final_tag >>-arm64.tar
            
            ls -al
      - persist_to_workspace:
          root: images
          paths:
            - "*"
  build-hysds_cuda_pge_base-amd64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/cuda-pge-base (amd64)
          command: |
            set -ex
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull amd64 base images
            docker pull hysds/cuda-base:<< parameters.final_tag >>-amd64
            docker pull hysds/cuda-dev:<< parameters.final_tag >>-amd64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-verdi.git
            cd puppet-verdi
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker_cuda.sh << parameters.final_tag >>-amd64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-amd64 << parameters.base_branch >>
            
            # Push the image
            docker push hysds/cuda-pge-base:<< parameters.final_tag >>-amd64
            
            cd ..
            rm -rf puppet-verdi
  build-hysds_cuda_pge_base-arm64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    resource_class: arm.medium
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/cuda-pge-base (arm64)
          command: |
            set -ex
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull arm64 base images
            docker pull hysds/cuda-base:<< parameters.final_tag >>-arm64
            docker pull hysds/cuda-dev:<< parameters.final_tag >>-arm64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-verdi.git
            cd puppet-verdi
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker_cuda.sh << parameters.final_tag >>-arm64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-arm64 << parameters.base_branch >>
            
            # Push the image
            docker push hysds/cuda-pge-base:<< parameters.final_tag >>-arm64
            
            cd ..
            rm -rf puppet-verdi
  build-hysds_cuda_pge_base-manifest:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - prep_env
      - run:
          name: Create hysds/cuda-pge-base manifest
          command: |
            set -ex
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Create and push manifest for final_tag
            if [ "$push_build_tag" -eq 1 ]; then
              docker manifest create hysds/cuda-pge-base:${build_tag} \
                hysds/cuda-pge-base:<< parameters.final_tag >>-amd64 \
                hysds/cuda-pge-base:<< parameters.final_tag >>-arm64
              docker manifest push hysds/cuda-pge-base:${build_tag}
            fi
            docker manifest create hysds/cuda-pge-base:<< parameters.final_tag >> \
              hysds/cuda-pge-base:<< parameters.final_tag >>-amd64 \
              hysds/cuda-pge-base:<< parameters.final_tag >>-arm64
            docker manifest push hysds/cuda-pge-base:<< parameters.final_tag >>
  build-hysds_mozart-amd64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/mozart (amd64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull amd64 base images
            docker pull hysds/base:<< parameters.final_tag >>-amd64
            docker pull hysds/dev:<< parameters.final_tag >>-amd64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-mozart.git
            cd puppet-mozart
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker.sh << parameters.final_tag >>-amd64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-amd64 << parameters.base_branch >>
            
            # Push the image
            docker push hysds/mozart:<< parameters.final_tag >>-amd64
            
            cd ..
            rm -rf puppet-mozart
  build-hysds_mozart-arm64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    resource_class: arm.medium
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/mozart (arm64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull arm64 base images
            docker pull hysds/base:<< parameters.final_tag >>-arm64
            docker pull hysds/dev:<< parameters.final_tag >>-arm64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-mozart.git
            cd puppet-mozart
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker.sh << parameters.final_tag >>-arm64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-arm64 << parameters.base_branch >>
            
            # Push the image
            docker push hysds/mozart:<< parameters.final_tag >>-arm64
            
            cd ..
            rm -rf puppet-mozart
  build-hysds_mozart-manifest:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Create multi-arch manifest for hysds/mozart
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Create and push manifest list
            docker manifest create hysds/mozart:<< parameters.final_tag >> \
              hysds/mozart:<< parameters.final_tag >>-amd64 \
              hysds/mozart:<< parameters.final_tag >>-arm64
            docker manifest push hysds/mozart:<< parameters.final_tag >>
  build-hysds_metrics-amd64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/metrics (amd64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull amd64 base images
            docker pull hysds/base:<< parameters.final_tag >>-amd64
            docker pull hysds/dev:<< parameters.final_tag >>-amd64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-metrics.git
            cd puppet-metrics
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker.sh << parameters.final_tag >>-amd64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-amd64 << parameters.base_branch >>
            
            # Push the image
            docker push hysds/metrics:<< parameters.final_tag >>-amd64
            
            cd ..
            rm -rf puppet-metrics
  build-hysds_metrics-arm64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    resource_class: arm.medium
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/metrics (arm64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull arm64 base images
            docker pull hysds/base:<< parameters.final_tag >>-arm64
            docker pull hysds/dev:<< parameters.final_tag >>-arm64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-metrics.git
            cd puppet-metrics
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker.sh << parameters.final_tag >>-arm64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-arm64 << parameters.base_branch >>
            
            # Push the image
            docker push hysds/metrics:<< parameters.final_tag >>-arm64
            
            cd ..
            rm -rf puppet-metrics
  build-hysds_metrics-manifest:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Create multi-arch manifest for hysds/metrics
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Create and push manifest list
            docker manifest create hysds/metrics:<< parameters.final_tag >> \
              hysds/metrics:<< parameters.final_tag >>-amd64 \
              hysds/metrics:<< parameters.final_tag >>-arm64
            docker manifest push hysds/metrics:<< parameters.final_tag >>
  build-hysds_grq-amd64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/grq (amd64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull amd64 base images
            docker pull hysds/base:<< parameters.final_tag >>-amd64
            docker pull hysds/dev:<< parameters.final_tag >>-amd64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-grq.git
            cd puppet-grq
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker.sh << parameters.final_tag >>-amd64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-amd64 << parameters.base_branch >>
            
            # Push the image
            docker push hysds/grq:<< parameters.final_tag >>-amd64
            
            cd ..
            rm -rf puppet-grq
  build-hysds_grq-arm64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    resource_class: arm.medium
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/grq (arm64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull arm64 base images
            docker pull hysds/base:<< parameters.final_tag >>-arm64
            docker pull hysds/dev:<< parameters.final_tag >>-arm64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-grq.git
            cd puppet-grq
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker.sh << parameters.final_tag >>-arm64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-arm64 << parameters.base_branch >>
            
            # Push the image
            docker push hysds/grq:<< parameters.final_tag >>-arm64
            
            cd ..
            rm -rf puppet-grq
  build-hysds_grq-manifest:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Create multi-arch manifest for hysds/grq
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Create and push manifest list
            docker manifest create hysds/grq:<< parameters.final_tag >> \
              hysds/grq:<< parameters.final_tag >>-amd64 \
              hysds/grq:<< parameters.final_tag >>-arm64
            docker manifest push hysds/grq:<< parameters.final_tag >>
  build-hysds_cont_int-amd64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/cont_int (amd64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull amd64 base images
            docker pull hysds/base:<< parameters.final_tag >>-amd64
            docker pull hysds/dev:<< parameters.final_tag >>-amd64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-cont_int.git
            cd puppet-cont_int
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker.sh << parameters.final_tag >>-amd64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-amd64 << parameters.base_branch >>
            
            # Push the image
            docker push hysds/cont_int:<< parameters.final_tag >>-amd64
            
            cd ..
            rm -rf puppet-cont_int
  build-hysds_cont_int-arm64:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    resource_class: arm.medium
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Build hysds/cont_int (arm64)
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Pull arm64 base images
            docker pull hysds/base:<< parameters.final_tag >>-arm64
            docker pull hysds/dev:<< parameters.final_tag >>-arm64
            
            git clone --single-branch -b << parameters.puppet_branch >> https://github.com/<< parameters.org >>/puppet-cont_int.git
            cd puppet-cont_int
            
            # Build with the final architecture-specific tag directly (without buildx to create single-platform images)
            ./build_docker.sh << parameters.final_tag >>-arm64 << parameters.org >> << parameters.puppet_branch >> << parameters.framework_branch >> << parameters.hysds_release >> << parameters.final_tag >>-arm64 << parameters.base_branch >>
            
            # Push the image
            docker push hysds/cont_int:<< parameters.final_tag >>-arm64
            
            cd ..
            rm -rf puppet-cont_int
  build-hysds_cont_int-manifest:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: hysds
      puppet_branch:
        type: string
        default: docker
      build_tag:
        type: string
      final_tag:
        type: string
      framework_branch:
        type: string
        default: develop
      hysds_release:
        type: string
        default: develop
      base_branch:
        type: string
        default: develop
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Create multi-arch manifest for hysds/cont_int
          command: |
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            # Create and push manifest list
            docker manifest create hysds/cont_int:<< parameters.final_tag >> \
              hysds/cont_int:<< parameters.final_tag >>-amd64 \
              hysds/cont_int:<< parameters.final_tag >>-arm64
            docker manifest push hysds/cont_int:<< parameters.final_tag >>
  deploy:
    docker:
      - image: alpine:latest
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: $CIRCLE_PROJECT_USERNAME
      repo:
        type: string
        default: $CIRCLE_PROJECT_REPONAME
      build_tag:
        type: string
      final_tag:
        type: string
    steps:
      - run:
          name: Install dependencies
          command: |
            apk add --no-cache curl file
            echo "@community http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
            apk add --no-cache github-cli@community
      - attach_workspace:
          at: images
      - run:
          name: Deploy
          command: |
            set -e
            export build_tag=<< parameters.build_tag >>
            export push_build_tag=1
            if [ -z "$build_tag" ]; then
              export build_tag=$(date -u +%Y%m%d)
              export push_build_tag=0
            fi
            cd images
            ls -al
            org=<< parameters.org >>
            repo=<< parameters.repo >>
            set +x
            echo $GIT_OAUTH_TOKEN | gh auth login --with-token
            set -x
            tag=$(gh release list -R ${org}/${repo} -L 1 | awk 'BEGIN{FS=":"}{print $1}')
            if [ "$push_build_tag" -eq 1 ]; then
              # Upload amd64 tarball (no suffix for backwards compatibility)
              gh release upload ${tag} hysds-verdi-<< parameters.build_tag >>.tar.gz -R ${org}/${repo} --clobber
              # Upload arm64 tarball (with suffix)
              gh release upload ${tag} hysds-verdi-<< parameters.build_tag >>-arm64.tar.gz -R ${org}/${repo} --clobber
            fi
            repo=hysds-dockerfiles
            tag=$(gh release list -R ${org}/${repo} -L 1 | awk 'BEGIN{FS=":"}{print $1}')
            # Upload amd64 tarball for final_tag (no suffix for backwards compatibility)
            gh release upload ${tag} hysds-verdi-<< parameters.final_tag >>.tar.gz -R ${org}/${repo} --clobber
            # Upload arm64 tarball for final_tag (with suffix)
            gh release upload ${tag} hysds-verdi-<< parameters.final_tag >>-arm64.tar.gz -R ${org}/${repo} --clobber
  export-support-assets:
    docker:
      - image: docker:24.0.9-git
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      - install_deps
      - setup_buildx
      - prep_env
      - run:
          name: Load support assets and save to files
          command: |
            mkdir -p assets
            cd assets
            
            # Pull and save multi-platform images
            # Note: docker save will save all architectures from a multi-arch manifest
            docker pull registry:2
            docker save registry:2 > docker-registry-2.tar
            pigz -f docker-registry-2.tar

            docker pull hysds/verdi:develop-es1
            docker save hysds/verdi:develop-es1 > hysds-verdi-develop-es1.tar
            pigz -f hysds-verdi-develop-es1.tar

            docker pull hysds/logstash:7.1.1
            docker tag hysds/logstash:7.1.1 logstash:7.1.1
            docker save logstash:7.1.1 > logstash-7.1.1.tar
            pigz -f logstash-7.1.1.tar

            docker pull hysds/logstash:7.9.3
            docker tag hysds/logstash:7.9.3 logstash:7.9.3
            docker save logstash:7.9.3 > logstash-7.9.3.tar
            pigz -f logstash-7.9.3.tar

            docker pull opensearchproject/logstash-oss-with-opensearch-output-plugin:7.16.3
            docker tag opensearchproject/logstash-oss-with-opensearch-output-plugin:7.16.3 logstash-oss:7.16.3
            docker save logstash-oss:7.16.3 > logstash-oss-7.16.3.tar
            pigz -f logstash-oss-7.16.3.tar
      - persist_to_workspace:
          root: assets
          paths:
            - "*"
  deploy-support-assets:
    docker:
      - image: alpine:latest
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    parameters:
      org:
        type: string
        default: $CIRCLE_PROJECT_USERNAME
    steps:
      - run:
          name: Install dependencies
          command: |
            apk add --no-cache curl file
            echo "@community http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
            apk add --no-cache github-cli@community
      - attach_workspace:
          at: assets
      - run:
          name: Deploy
          command: |
            cd assets
            org=<< parameters.org >>
            repo=hysds-dockerfiles
            echo $GIT_OAUTH_TOKEN | gh auth login --with-token
            tag=$(gh release list -R ${org}/${repo} -L 1 | awk 'BEGIN{FS=":"}{print $1}')
            for file in *; do
              gh release upload ${tag} ${file} -R ${org}/${repo} --clobber
            done

workflows:
  version: 2
  test:
    jobs:
      - test:
          context:
            - docker-hub-creds
            - git-oauth-token
  weekly:
    triggers:
      - schedule:
          cron: "0 7 * * 0"
          filters:
            branches:
              only:
                - develop
    jobs:
      - test:
          context:
            - docker-hub-creds
            - git-oauth-token
          filters:
            branches:
              only: develop
  build-deploy-develop:
    jobs:
      - build-redis:
          branch: master
          build_tag: ""
          final_tag: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
          filters:
            branches:
              only: develop
      - build-elasticsearch:
          build_tag: ""
          final_tag: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          filters:
            branches:
              only: develop
      - build-rabbitmq:
          branch: develop
          build_tag: ""
          final_tag: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          filters:
            branches:
              only: develop
      - build-hysds_base-amd64:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          filters:
            branches:
              only: HC-567
      - build-hysds_base-arm64:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          filters:
            branches:
              only: HC-567
      - build-hysds_base-manifest:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-amd64
            - build-hysds_base-arm64
          filters:
            branches:
              only: HC-567
      - build-hysds_dev-amd64:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_dev-arm64:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_dev-manifest:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_dev-amd64
            - build-hysds_dev-arm64
          filters:
            branches:
              only: HC-567
      - build-hysds_cuda_base-amd64:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_cuda_base-arm64:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_cuda_base-manifest:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_base-amd64
            - build-hysds_cuda_base-arm64
          filters:
            branches:
              only: HC-567
      - build-hysds_cuda_dev-amd64:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_base-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_cuda_dev-arm64:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_base-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_cuda_dev-manifest:
          branch: HC-567
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_dev-amd64
            - build-hysds_cuda_dev-arm64
          filters:
            branches:
              only: HC-567
      - build-hysds_verdi_pge_base-amd64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_verdi_pge_base-arm64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_verdi_pge_base-manifest:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_verdi_pge_base-amd64
            - build-hysds_verdi_pge_base-arm64
          filters:
            branches:
              only: HC-567
      - build-hysds_cuda_pge_base-amd64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_base-manifest
            - build-hysds_cuda_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_cuda_pge_base-arm64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_base-manifest
            - build-hysds_cuda_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_cuda_pge_base-manifest:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_pge_base-amd64
            - build-hysds_cuda_pge_base-arm64
          filters:
            branches:
              only: HC-567
      - build-hysds_mozart-amd64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_mozart-arm64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_mozart-manifest:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_mozart-amd64
            - build-hysds_mozart-arm64
          filters:
            branches:
              only: HC-567
      - build-hysds_metrics-amd64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_metrics-arm64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_metrics-manifest:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_metrics-amd64
            - build-hysds_metrics-arm64
          filters:
            branches:
              only: HC-567
      - build-hysds_grq-amd64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_grq-arm64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_grq-manifest:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_grq-amd64
            - build-hysds_grq-arm64
          filters:
            branches:
              only: HC-567
      - build-hysds_cont_int-amd64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_cont_int-arm64:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            branches:
              only: HC-567
      - build-hysds_cont_int-manifest:
          puppet_branch: HC-567
          build_tag: ""
          final_tag: HC-567
          framework_branch: HC-567
          hysds_release: develop
          base_branch: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cont_int-amd64
            - build-hysds_cont_int-arm64
          filters:
            branches:
              only: HC-567
      - deploy:
          build_tag: ""
          final_tag: HC-567
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_verdi_pge_base-manifest
          filters:
            branches:
              only: HC-567
  build-deploy-release:
    jobs:
      - build-redis:
          branch: master
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-elasticsearch:
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-rabbitmq:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_base-amd64:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_base-arm64:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_base-manifest:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-amd64
            - build-hysds_base-arm64
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_dev-amd64:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_dev-arm64:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_dev-manifest:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_dev-amd64
            - build-hysds_dev-arm64
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cuda_base-amd64:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cuda_base-arm64:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cuda_base-manifest:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_base-amd64
            - build-hysds_cuda_base-arm64
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cuda_dev-amd64:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_base-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cuda_dev-arm64:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_base-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cuda_dev-manifest:
          branch: develop
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_dev-amd64
            - build-hysds_cuda_dev-arm64
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_verdi_pge_base-amd64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_verdi_pge_base-arm64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_verdi_pge_base-manifest:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_verdi_pge_base-amd64
            - build-hysds_verdi_pge_base-arm64
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cuda_pge_base-amd64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_base-manifest
            - build-hysds_cuda_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cuda_pge_base-arm64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_base-manifest
            - build-hysds_cuda_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cuda_pge_base-manifest:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cuda_pge_base-amd64
            - build-hysds_cuda_pge_base-arm64
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_mozart-amd64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_mozart-arm64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_mozart-manifest:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_mozart-amd64
            - build-hysds_mozart-arm64
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_metrics-amd64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_metrics-arm64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_metrics-manifest:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_metrics-amd64
            - build-hysds_metrics-arm64
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_grq-amd64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_grq-arm64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_grq-manifest:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_grq-amd64
            - build-hysds_grq-arm64
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cont_int-amd64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cont_int-arm64:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_base-manifest
            - build-hysds_dev-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - build-hysds_cont_int-manifest:
          puppet_branch: docker
          build_tag: $CIRCLE_TAG
          final_tag: latest
          framework_branch: $CIRCLE_TAG
          hysds_release: $CIRCLE_TAG
          base_branch: develop
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_cont_int-amd64
            - build-hysds_cont_int-arm64
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - deploy:
          build_tag: $CIRCLE_TAG
          final_tag: latest
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - build-hysds_verdi_pge_base-manifest
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - export-support-assets:
          context:
            - docker-hub-creds
            - git-oauth-token
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
      - deploy-support-assets:
          context:
            - docker-hub-creds
            - git-oauth-token
          requires:
            - export-support-assets
          filters:
            tags:
              only: /^v6.*/
            branches:
              ignore: /.*/
